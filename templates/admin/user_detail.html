{% extends "admin/base.html" %} {% block title %}使用者詳情 - Chi Soo 管理後台{%
endblock %} {% block extra_css %}
<style>
  .avatar-lg {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid #e5e7eb;
    object-fit: cover;
  }
  .status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  .data-box {
    background: #1f2937;
    color: #a5f3fc;
    padding: 20px;
    border-radius: 8px;
    font-family: monospace;
    white-space: pre-wrap;
    max-height: 400px;
    overflow-y: auto;
  }
</style>
{% endblock %} {% block header_title %}
<div style="display: flex; align-items: center; gap: 10px">
  <a href="/" class="btn btn-secondary btn-sm"
    ><i class="fa-solid fa-arrow-left"></i
  ></a>
  <span>使用者檔案</span>
</div>
{% endblock %} {% block content %}
<div class="card">
  <div style="display: flex; align-items: center; gap: 20px">
    {% if user.picture_url %}
    <img src="{{ user.picture_url }}" class="avatar-lg" />
    {% else %}
    <div
      class="avatar-lg"
      style="
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: #9ca3af;
      "
    >
      ?
    </div>
    {% endif %}
    <div>
      <h3 style="font-size: 1.5rem; margin-bottom: 5px">
        {{ user.display_name or 'Unknown User' }}
      </h3>
      <div style="color: #6b7280; font-family: monospace; margin-bottom: 5px">
        ID: {{ user.user_id }}
      </div>
      <div style="display: flex; gap: 10px; margin-top: 10px">
        <span class="status-badge" style="background: #e0f2fe; color: #0284c7">
          <i class="fa-solid fa-theater-masks"></i> {{ user.persona_type or
          '未分類' }}
        </span>
        {% if session %}
        <span class="status-badge" style="background: #fef3c7; color: #d97706">
          Session: {{ session.status }}
        </span>
        {% endif %}
      </div>
    </div>
    <div style="margin-left: auto">
      <form
        action="/clear-user-logs/{{ user.user_id }}"
        method="POST"
        onsubmit="return confirm('確定要清除此使用者的所有 AI 紀錄與標記嗎？');"
      >
        <button type="submit" class="btn btn-danger">
          <i class="fa-solid fa-trash-can"></i> 清除紀錄
        </button>
      </form>
    </div>
  </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 25px">
  <!-- Left: Collected Data -->
  <div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <i class="fa-solid fa-database"></i> 已收集資料 (Memory)
        </div>
      </div>
      {% if session and session.collected_data %}
      <div class="data-box">
        {{ session.collected_data | tojson(indent=2) }}
      </div>
      {% else %}
      <div style="color: #9ca3af; text-align: center; padding: 20px">
        尚無資料
      </div>
      {% endif %}
    </div>

    <!-- User Weights -->
    <div class="card" style="margin-top: 20px">
      <div class="card-header">
        <div class="card-title">
          <i class="fa-solid fa-scale-balanced"></i> 價值觀權重 (Weights)
        </div>
      </div>
      {% if session and session.weights %}

      <!-- Radar Chart Container -->
      <div style="position: relative; height: 300px; margin-bottom: 20px">
        <canvas id="weightRadarChart"></canvas>
      </div>
      <!-- JSON Data for Chart (avoids HTML attribute escaping issues) -->
      <script type="application/json" id="weights-data">
        {{ session.weights | tojson | safe }}
      </script>

      <!-- Data Table -->
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>維度</th>
            <th>數值</th>
          </tr>
        </thead>
        <tbody>
          {% for k, v in session.weights.items() %}
          <tr>
            <!-- Mapping labels for display -->
            {% set label_map = {'budget': '預算', 'location': '地段',
            'features': '設施', 'landlord': '房東', 'type': '房型', 'keyword':
            '關鍵字'} %}
            <td>{{ label_map.get(k, k) }}</td>
            <td style="font-weight: bold; color: #6366f1">{{ v }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Render Chart Script -->
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const dataElement = document.getElementById("weights-data");
          if (!dataElement) return;

          let weights;
          try {
            weights = JSON.parse(dataElement.textContent);
          } catch (e) {
            console.error("Failed to parse weights data", e);
            return;
          }

          const canvas = document.getElementById("weightRadarChart");
          if (!canvas) return;

          // Labels mapping
          const labelMap = {
            budget: "預算",
            location: "地段",
            features: "設施",
            landlord: "房東",
            type: "房型",
            keyword: "關鍵字",
          };

          const labels = Object.keys(weights).map((k) => labelMap[k] || k);
          const data = Object.values(weights);

          const ctx = canvas.getContext("2d");
          new Chart(ctx, {
            type: "radar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "價值觀分佈",
                  data: data,
                  fill: true,
                  backgroundColor: "rgba(99, 102, 241, 0.2)",
                  borderColor: "rgb(99, 102, 241)",
                  pointBackgroundColor: "rgb(99, 102, 241)",
                  pointBorderColor: "#fff",
                  pointHoverBackgroundColor: "#fff",
                  pointHoverBorderColor: "rgb(99, 102, 241)",
                },
              ],
            },
            options: {
              maintainAspectRatio: false,
              elements: {
                line: { borderWidth: 3 },
              },
              scales: {
                r: {
                  angleLines: { display: true },
                  suggestedMin: 0,
                  suggestedMax: 100,
                  ticks: { display: false }, // Hide numbers on axis
                },
              },
              plugins: {
                legend: { display: false },
              },
            },
          });
        });
      </script>

      {% else %}
      <div style="color: #9ca3af; text-align: center; padding: 20px">
        尚無權重資料
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Right: AI Logs -->
  <div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <i class="fa-solid fa-brain"></i> AI 思考歷程 ({{ logs | length }})
        </div>
      </div>
      {% if logs %}
      <div style="overflow-x: auto">
        <table>
          <thead>
            <tr>
              <th>時間</th>
              <th>對話內容</th>
              <th>資訊提取</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
            <tr>
              <td
                style="white-space: nowrap; font-size: 0.85rem; color: #6b7280"
              >
                {{ log.created_at.strftime('%m/%d %H:%M') }}
              </td>
              <td>
                <div style="font-weight: 500; margin-bottom: 4px">
                  Q: {{ log.user_input }}
                </div>
                <div style="color: #6b7280; font-size: 0.9rem">
                  A: {{ log.ai_raw_response[:50] }}...
                </div>
              </td>
              <td>
                {% if log.extracted_data != '{}' %}
                <code
                  style="
                    background: #f3f4f6;
                    padding: 2px 5px;
                    border-radius: 4px;
                    font-size: 0.8rem;
                    color: #059669;
                  "
                  >{{ log.extracted_data }}</code
                >
                {% else %}
                <span style="color: #d1d5db">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div style="padding: 40px; text-align: center; color: #9ca3af">
        <i
          class="fa-solid fa-comment-slash"
          style="font-size: 2rem; margin-bottom: 10px"
        ></i>
        <p>尚無對話紀錄</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Chart script is already in the content block -->
{% endblock %}
